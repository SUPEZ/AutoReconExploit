import sys
import os
import nmap
import re

ipTarget = 0
rangePorts = 0
ignoreIP = ["192.168.1.5"]


def recon():
    try:
        nm = nmap.PortScanner()
        nm.scan(ipTarget, rangePorts)
    except nmap.PortScannerError:
        print('Nmap not found', sys.exc_info()[0])
    except:
        print("Unexpected error:", sys.exc_info()[0])
        sys.exit(0)

    for host in nm.all_hosts():
        if host in ignoreIP:
            print("Ignore " + host)
        else:
            print("---------" * 10)
            print("     Host: %s (%s)" % (host, ipTarget))
            print("     State: %s" % nm[host].state())
            mac = nm[host]['addresses']['mac']
            if mac != " ":
                print("     Mac: %s" % mac)
                print("     Machine type: %s" % nm[host]['vendor'][mac])
            print("---------" * 10)
            for proto in nm[host].all_protocols():
                print("+++++++++" * 10)
                print("     protocol : %s" % proto)
                ports = nm[host][proto].keys()
                for port in ports:
                    print("     Port : %s\tState : %s\tService : %s\tProduct : %s\tVersion : %s" % (
                        port, nm[host][proto][port]['state'], nm[host][proto][port]['name'],
                        nm[host][proto][port]['product'], nm[host][proto][port]['version']))
                    os.system("searchsploit " + nm[host][proto][port]['name'] + " " + str(nm[host][proto][port]['product'].split(' ', 1)[0]))
                print("+++++++++" * 10)


def main():
    global ipTarget, rangePorts
    # Get command arguments.
    if len(sys.argv) != 3:
        print("./AutoExploit.py <<IP ADDRESS>> <<PORT RANGE>>")
        sys.exit(0)

    ipTarget = sys.argv[1]
    rangePorts = sys.argv[2]

    print("---------" * 10)
    print("     SCANNING THE TARGET " + ipTarget)
    print("---------" * 10)
    recon()


if __name__ == "__main__":
    sys.exit(main())
